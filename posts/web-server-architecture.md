Webアプリを開発していても、Webサーバーがプロセスやスレッドでどのようにリクエストを処理しているかといった知識が必要になることは少ないです。
依然としてWebアプリはWebサーバーの上で動いてはいますが、クラウドのマネージドサービスで動かすことも多くなった現代でそういった知識が必要になるケースは、経験の少ない僕には想像できません。アプリのボトルネックはもう少し高いレイヤーにあることが多く、そちらを学ぶほうが効率が良いと考えています。

ただ、Webアプリを開発しているとWebサーバーがどのように動いているのか気になると思います。僕は気になります。
具体的には、Webサーバーがどのように複数のリクエストを処理しているのかがわかりませんでした。

この投稿はWebサーバーの仕組みについて、ネットワークプログラミングの概要からアーキテクチャまでを調べ、自分の理解のためにまとめたものです。

## Webサーバーとは

Webサーバーとは、リクエストを受けて何らかのデータをレスポンスとして返すソフトウェアやハードウェアのことです。
データとしてはHTMLページ、画像、CSSスタイルシート、JavaScriptファイル、JSONなどがあり、要求に応じてこれらのデータを返します。

現代のWebサーバーは複数のクライアントからのリクエストを並行して処理する必要があります。
一つのリクエストが処理されるまで他のリクエストをブロックするというように、リクエストを一つずつ処理するだけならイメージはつきやすいと思います。
しかし実際には並行処理が行われるため複雑になります。

Webサーバーのアーキテクチャは並行処理の手法の数だけ存在し、詳細を理解するためにはシステムプログラミングの領域に踏み込む必要があります。
アーキテクチャを処理を委譲する実行環境で分けると、マルチプロセス・マルチスレッド・イベント駆動・ハイブリッド・グリーンスレッドなどがあります。
また、各実行環境でリクエストが処理される方法も異なります。

## ネットワークプログラミングの概要

Webサーバーの仕組みを知るために重要なシステムプログラミングの領域はネットワーク通信です。
Webサーバーはクライアントからネットワークを通してリクエストを受け付けたあと、クライアントからデータを受け取ったり、クライアントにデータを渡したりします。

### 基礎知識

#### システムコール

ここではシステムコールを利用するプログラミングをシステムプログラミングと呼びます。

システムコールは、アプリケーションがOSのカーネルの機能を呼び出すための方法です。
現代のCPUではセキュリティのためにユーザーモードとカーネルモードを区別しています。
カーネルモードは無制限の操作が可能ですが、ユーザーモードには制限があります。
OSは、カーネルモードで動作する処理をシステムコールとして提供し、アプリケーションはシステムコールを通じてカーネルモードでの操作を実行します。

代表的なシステムコールとしては、`open`、`read`、`write`、`close`などがあり、ファイルの操作を行います。
後述するネットワーク通信で使用されるソケットに関連するものとしては、`socket`、`bind`、`listen`、`accept`、`connect`などがあります。
他にネットワーク通信で重要になってくるものだと、`select`や`epoll`(`kqueue`)のような後述するI/Oイベントの通知のためのシステムコールがあります。

#### ソケット

ネットワーク通信では、ソケットと呼ばれるインターフェースが使用されます。

> [!info]
> ソケットにはUDPで通信するためのUDPソケットや、ネットワークに限らないプロセス間通信を行うためのUNIXドメインソケットなどがありますが、ここでは
> ソケットとだけ言う場合にはTCPソケットを指します。

ソケットは通信におけるエンドポイントを表現したデータモデルのことで、

- ローカルIPアドレス
- ローカルTCPポート
- リモートIPアドレス
- リモートTCPポート

が含まれます。
例えばクライアントとWebサーバーが通信しているとき、Webサーバー側のソケットには、Webサーバー自身の情報がローカルIPアドレス・TCPポートに含まれており、
通信先のクライアントの情報がリモートIPアドレス・TCPポートに含まれています。

ネットワーク通信ではソケットを使用して、クライアントからデータを受け取ったり、クライアントにデータを渡すことができます。
具体的には、ソケットを読み取ることでデータを受け取り、ソケットに対して書き込むことでデータを渡すことができます。

#### ファイルディスクリプタ

ソケットは**ファイルディスクリプタ**と呼ばれる整数によって参照されます。

ファイルディスクリプタはUnixにおいてプロセス内のファイルを参照するときに使用される整数のことで、Unixでは様々なリソースがこれによって参照されます。
ファイルやソケットのほか、接続されているキーボードや仮想デバイスであるターミナルなどもあります。
ファイルディスクリプタはプロセス内で一意な整数であり、プロセス間では一意な整数にはなっていません。

Unixのこのような思想は「**Everything is a file**」と呼ばれ、統一したインターフェースであらゆるリソースを扱えるようになります。
例えばファイルの読み込み・書き込みとソケットの読み込み・書き込みを同じシステムコールで行えたり、あらゆるリソースのI/Oイベントの通知を一つのシステムコールで監視することができます。

Web開発でもよく見る標準入力、標準出力、標準エラー出力にもファイルディスクリプタが割り当てられており、それぞれ0、1、2になっています。
画面への出力は、標準出力のファイルディスクリプタである1に対してファイル書き込みのシステムコールを実行することで実現できます。

### ブロッキングI/O

### ノンブロッキングI/OとI/O多重化

## Webサーバーアーキテクチャ

### マルチプロセス

### マルチスレッド

### イベント駆動

### ハイブリッド

## Webサーバーの変遷

## リバースプロキシ/ロードバランサ

## さいごに

## 参考資料

- [2015年Webサーバアーキテクチャ序論](https://blog.yuuk.io/entry/2015-webserver-architecture)
- [Webサーバーアーキテクチャ進化論2023](https://blog.ojisan.io/server-architecture-2023)
- [WebエンジニアとWeb技術とシステムの話 (sadnessOjisanのWebサーバーアーキテクチャ進化論2023を読んだ感想)](https://blog.inductor.me/entry/2023/04/03/153149)
- [なるほどTCPソケット(Working with TCP sockets)](https://www.snoozer05.org/naruhotcp)
- [Webサーバにおけるソケット周りの知識](https://christina04.hatenablog.com/entry/socket-base)
- [Non-Blocking I/O, I/O Multiplexing, Asynchronous I/Oの区別](https://christina04.hatenablog.com/entry/2017/07/05/005944)
- [I/O Multiplexing（I/O多重化）](https://christina04.hatenablog.com/entry/io-multiplexing)
- [ノンブロッキングI/Oと非同期I/Oの違いを理解する](https://blog.takanabe.tokyo/2015/03/%E3%83%8E%E3%83%B3%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0i/o%E3%81%A8%E9%9D%9E%E5%90%8C%E6%9C%9Fi/o%E3%81%AE%E9%81%95%E3%81%84%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B/)
